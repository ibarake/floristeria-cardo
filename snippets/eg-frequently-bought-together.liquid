{% comment %}
  EG Frequently Bought Together (FBT)
  Â© 2022 EcomGraduates
  https://wwww.ecomgraduates.com
{% endcomment %}

{% liquid
  comment
    Snippet Options
  endcomment
  assign heading_title = 'Add combo'
  assign heading_size = 'h3'
  assign item_width = '33%'
  assign limit = 3
  assign text_align = 'center'
  assign img_width = 360
  assign img_height = 360
  assign upsell_tag = 'upsell:'
  assign text_add_this = 'Add this'
  assign text_total_price = 'Total Price'
  assign text_add_selected = 'Add selected to cart'
%}

{% liquid
  assign product_handles = product.handle | append: ','
  for tag in product.tags
    if tag contains upsell_tag
      assign handle = tag | split: ':' | last
      assign product_handles = product_handles | append: handle | append: ','
    endif
  endfor
  assign product_handles = product_handles | split: ','
%}

{% if product_handles.size > 1 %}
  <style>
    /* General styles */
    .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0,0,0,0);
        white-space: nowrap;
        border: 0;
    }
    .img-fluid {
        max-width: 100px;
        height: auto;
    }
    @keyframes spinner-border {
        to { transform: rotate(360deg) }
    }
    .spinner-border {
        display: inline-block;
        width: 1.5rem;
        height: 1.5rem;
        vertical-align: -0.125em;
        border: 0.15em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: 0.75s linear infinite spinner-border;
    }

    /* Snippet styling */
    frequently-bought-together {
        display: block;
        margin: 2rem 0;
        text-align: {{ text_align }};
    }
    .fbt-heading-title {
        margin: 0 0 1rem;
    }
    .fbt-product-list {
        list-style: none;
        display: flex;
        flex-wrap: wrap;
        margin: 0 -.5rem;
        padding: 0;
    }
    .fbt-product-item {
        width: {{ item_width }};
        padding: .5rem;
        margin: 0 0 1rem;
    }
    .fbt-product-img {
        margin: 0 0 .5rem;
    }
    .fbt-product-title {
        margin: 0 0 .5rem;
        font-size: .875em;
    }
    .fbt-product-price {
        margin: 0 0 .5rem;
    }
    .fbt-product-price-compare {
        opacity: .5;
        font-size: .875em;
        margin-right: .25rem;
    }
    .fbt-variant-select {
        width: 100%;
        border: 1px solid rgba(0, 0, 0, .5);
        padding: 0.25rem;
        line-height: normal;
        display: block;
        margin: 0 0 0.5rem;
        color: rgba(0, 0, 0, .75);
    }
    .fbt-variant-select:focus {
        outline: none;
        border-color: rgba(0, 0, 0, 1);
        box-shadow: none;
    }
    .fbt-add-checkbox-wrapper {
        display: inline-flex;
        align-items: center;
    }
    .fbt-add-checkbox-wrapper .fbt-add-checkbox {
        margin-right: .75rem;
    }
    .fbt-total-price-wrapper {
        margin: 0 0 1rem;
        font-size: 1.125em;
    }
    .fbt-btn-atc {
        margin-bottom: .5rem;
    }
  </style>

  <frequently-bought-together>
    <h2 class="fbt-heading-title {{ heading_size }}">
      {{ heading_title }}
    </h2>
    <ul class="fbt-product-list">
      {% for handle in product_handles limit: limit %}
        {% assign product = all_products[handle] %}
        {% assign total_price = total_price | plus: product.selected_or_first_available_variant.price %}
        <li class="fbt-product-item">
          <a class="" href="{{ product.url }}">
            <img
              class="fbt-product-img img-fluid {{ section.settings.fbt_product_img_border }}"
              src="{{ product.featured_image.src | image_url: width: img_width, height: img_height, crop: 'center' }}"
              alt="{{ product.featured_image.alt | escape }}"
              width="{{ img_width }}"
              height="{{ img_height }}"
              loading="lazy"
            >
          </a>
          <h3 class="fbt-product-title h6">
            <a class="" href="{{ product.url }}">
              {{ product.title }}
            </a>
          </h3>
          <p class="fbt-product-price">
            <span
              class="fbt-product-price-compare"
              style="{% unless product.first_available_variant.compare_at_price > product.first_available_variant.price %}display: none;{% endunless %}"
            >
              <span class="visually-hidden"> Regular price </span>
              <s>
                {{ product.first_available_variant.compare_at_price | money }}
              </s>
            </span>
            <span class="fbt-product-price-final">
              {{ product.price | money }}
            </span>
          </p>
          <select
            class="fbt-variant-select"
            name="id"
            aria-label="Select variant"
            style="{% if product.has_only_default_variant %}display: none;{% endif %}"
          >
            {% for variant in product.variants %}
              {% liquid
                assign variant_image = null
                if variant.image
                  assign variant_image = variant.image | image_url: width: img_width, height: img_height, crop: 'center'
                endif
              %}
              <option
                value="{{ variant.id }}"
                data-image="{{ variant_image }}"
                data-compare-price="{{ variant.compare_at_price }}"
                data-price="{{ variant.price }}"
                {% unless variant.available %}
                  disabled
                {% endunless %}
              >
                {{ variant.title }}
              </option>
            {% endfor %}
          </select>
          <div class="fbt-add-checkbox-wrapper">
            <input id="fbt-add-checkbox-{{ product.id }}" class="fbt-add-checkbox" type="checkbox" checked>
            <label class="" for="fbt-add-checkbox-{{ product.id }}">
              {{ text_add_this }}
            </label>
          </div>
        </li>
      {% endfor %}
    </ul>
    <p class="fbt-total-price-wrapper">
      <span class=""> {{ text_total_price }}: </span>
      <b class="fbt-total-price">
        {{ total_price | money }}
      </b>
    </p>
    <button
      class="fbt-btn-atc button button--primary btn btn-primary"
      type="button"
      data-text-add-selected="{{ text_add_selected }}"
    >
      {{ text_add_selected }}
    </button>
  </frequently-bought-together>
{% endif %}
